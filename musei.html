<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giorgio Vigna - Musei | Collezioni Permanenti</title>
    <meta name="description" content="Le opere di Giorgio Vigna nelle collezioni permanenti di importanti istituzioni museali internazionali.">
    <meta name="keywords" content="Giorgio Vigna musei, collezioni permanenti, arte contemporanea, istituzioni museali">
    <meta property="og:title" content="Giorgio Vigna - Musei">
    <meta property="og:description" content="Scopri dove sono esposte le opere di Giorgio Vigna nei musei di tutto il mondo.">
    <link rel="canonical" href="https://giorgio-vigna.com/musei.html">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="page-content">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">Giorgio Vigna</a>
            <button class="nav-toggle" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-menu">
                <a href="opere.html" class="nav-link">Opere</a>
                <a href="musei.html" class="nav-link active">Musei</a>
                <a href="esposizioni.html" class="nav-link">Esposizioni</a>
                <a href="rassegna-stampa.html" class="nav-link">Rassegna Stampa</a>
                <a href="collaborazioni.html" class="nav-link">Collaborazioni</a>
                <a href="pubblicazioni.html" class="nav-link">Pubblicazioni</a>
                <a href="cataloghi.html" class="nav-link">Cataloghi</a>
                <!-- Language Switch Mobile -->
                <div class="language-switch-mobile">
                    <button class="lang-btn" data-lang="it">IT</button>
                    <button class="lang-btn" data-lang="en">EN</button>
                </div>
            </div>
            <!-- Language Switch Desktop -->
            <div class="language-switch">
                <button class="lang-btn" data-lang="it">IT</button>
                <button class="lang-btn" data-lang="en">EN</button>
            </div>
        </div>
    </nav>
    
    <script>
    // Set initial language button state
    (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlLang = urlParams.get('lang');
        const savedLang = localStorage.getItem('giorgio-vigna-lang');
        const lang = (urlLang === 'en' || urlLang === 'it') ? urlLang : 
                    (savedLang === 'en' || savedLang === 'it') ? savedLang : 'it';
        
        const langButtons = document.querySelectorAll('.lang-btn');
        const langSwitches = document.querySelectorAll('.language-switch, .language-switch-mobile');
        
        langButtons.forEach(btn => {
            if (btn.dataset.lang === lang) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // Set initial pill position
        langSwitches.forEach(switchEl => {
            if (lang === 'en') {
                switchEl.classList.add('en');
            } else {
                switchEl.classList.remove('en');
            }
        });
    })();
    </script>

    <section class="museums page-section">
        <div class="container">
            <div class="page-header">
                <h1 class="page-title">Musei</h1>
            </div>
            <div class="museums-content">
                <p data-original="Le opere di Giorgio Vigna sono presenti nelle collezioni permanenti di importanti istituzioni museali internazionali:">Le opere di Giorgio Vigna sono presenti nelle collezioni permanenti di importanti istituzioni museali internazionali:</p>
                
                <div class="museums-list">
                    <div class="museum-item">
                        <h3>MAD – Museum of Arts & Design</h3>
                        <p>New York (USA)</p>
                    </div>
                    <div class="museum-item">
                        <h3>The State Hermitage Museum</h3>
                        <p>San Pietroburgo (Russia)</p>
                    </div>
                    <div class="museum-item">
                        <h3>Honolulu Museum of Art</h3>
                        <p>Honolulu (Hawaii, USA)</p>
                    </div>
                    <div class="museum-item">
                        <h3>Gallerie dell'Accademia</h3>
                        <p data-original="Venezia (Italia)">Venezia (Italia)</p>
                    </div>
                    <div class="museum-item">
                        <h3>Museo di Castelvecchio</h3>
                        <p data-original="Verona (Italia)">Verona (Italia)</p>
                    </div>
                    <div class="museum-item">
                        <h3>Museo del Vetro</h3>
                        <p data-original="Murano, Venezia (Italia)">Murano, Venezia (Italia)</p>
                    </div>
                    <div class="museum-item">
                        <h3>Cooper Hewitt, Smithsonian Design Museum</h3>
                        <p>New York (USA)</p>
                    </div>
                    <div class="museum-item">
                        <h3>Indianapolis Museum of Art (IMA)</h3>
                        <p>Indianapolis, Indiana (USA)</p>
                    </div>
                    <div class="museum-item">
                        <h3>Ilias Lalaounis Jewelry Museum</h3>
                        <p>Atene (Grecia)</p>
                    </div>
                    <div class="museum-item">
                        <h3>Museo degli Argenti, Palazzo Pitti</h3>
                        <p data-original="Firenze (Italia)">Firenze (Italia)</p>
                    </div>
                    <div class="museum-item">
                        <h3>MIAAO – Museo Internazionale delle Arti Applicate Oggi</h3>
                        <p data-original="Torino (Italia)">Torino (Italia)</p>
                    </div>
                    <div class="museum-item">
                        <h3>Olnick Spanu Art Program</h3>
                        <p>Garrison, New York (USA)</p>
                    </div>
                    <div class="museum-item">
                        <h3>Olnick Spanu Collection</h3>
                        <p>New York (USA)</p>
                    </div>
                    <div class="museum-item">
                        <h3>Diane Venet Collection</h3>
                        <p data-original="Parigi (Francia)">Parigi (Francia)</p>
                    </div>
                    <div class="museum-item">
                        <h3>Designmuseo</h3>
                        <p data-original="Helsinki (Finlandia)">Helsinki (Finlandia)</p>
                    </div>
                    <div class="museum-item">
                        <h3>Civica Raccolta delle Stampe Achille Bertarelli</h3>
                        <p data-original="Castello Sforzesco, Milano (Italia)">Castello Sforzesco, Milano (Italia)</p>
                    </div>
                    <div class="museum-item">
                        <h3>Museo Barbier-Mueller</h3>
                        <p data-original="Ginevra (Svizzera)">Ginevra (Svizzera)</p>
                    </div>
                    <div class="museum-item">
                        <h3>Fondazione Raffaele Cominelli</h3>
                        <p data-original="San Felice del Benaco (BS, Italia)">San Felice del Benaco (BS, Italia)</p>
                    </div>
                    <div class="museum-item">
                        <h3>Collezione Bellini Pezzoli</h3>
                        <p data-original="Castello Sforzesco, Milano (Italia)">Castello Sforzesco, Milano (Italia)</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    </div>
    
    <!-- Delete Toolbar -->
    <div id="deleteToolbar" class="delete-toolbar">
        <span class="delete-count">0 selezionati</span>
        <button class="delete-btn" onclick="deleteSelected()">Elimina</button>
        <button class="cancel-delete" onclick="toggleDeleteMode()">Annulla</button>
    </div>
    
    <!-- Sort Toolbar -->
    <div id="sortToolbar" class="sort-toolbar">
        <span class="sort-info">Trascina per riordinare</span>
        <button class="sort-save" onclick="saveSortOrder()">OK</button>
        <button class="sort-cancel" onclick="exitSortMode()">Annulla</button>
    </div>
    
    <!-- Add Museum Modal -->
    <div id="museumModal" class="museum-modal">
        <div class="museum-modal-content">
            <h3>Aggiungi Nuovo Museo</h3>
            <form id="museumForm">
                <div class="museum-form-group">
                    <label for="museumName">Nome Museo</label>
                    <input type="text" id="museumName" required>
                </div>
                <div class="museum-form-group">
                    <label for="museumLocation">Location</label>
                    <input type="text" id="museumLocation" required>
                </div>
                <div class="museum-form-group">
                    <label for="museumLink">Link</label>
                    <input type="url" id="museumLink" placeholder="https://">
                </div>
                <div class="museum-modal-buttons">
                    <button type="button" class="museum-btn museum-btn-secondary" onclick="closeMuseumModal()">Annulla</button>
                    <button type="submit" class="museum-btn museum-btn-primary">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Lightbox -->
    <div id="lightbox" class="lightbox">
        <div class="lightbox-content">
            <span class="lightbox-close">&times;</span>
            <img id="lightbox-img" src="" alt="">
            <div class="lightbox-caption"></div>
        </div>
    </div>
    
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <p><strong>Giorgio Vigna</strong></p>
                    <p>Via Tortona 4, Milano 20144</p>
                    <p>Tel +39 02 58103947</p>
                    <p>P.IVA 13451250156</p>
                </div>
                <div class="admin-lock" onclick="toggleAdminPanel()"></div>
            </div>
        </div>
    </footer>
    
    <div class="admin-panel" id="adminPanel">
        <div id="loginForm">
            <h3>Admin Login</h3>
            <input type="text" id="adminUser" placeholder="Username">
            <input type="password" id="adminPass" placeholder="Password">
            <div id="loginError" class="login-error" style="display: none;"></div>
            <button class="admin-login" onclick="adminLogin()">Login</button>
            <button class="admin-cancel" onclick="toggleAdminPanel()">Cancel</button>
        </div>
        <div id="loggedInForm" style="display: none;">
            <h3>Admin Panel</h3>
            <button class="admin-login" onclick="adminLogout()">Logout</button>
            <button class="admin-cancel" onclick="toggleAdminPanel()">Cancel</button>
        </div>
    </div>
    
    <script src="script.js"></script>
    <script>
    // Check if admin is already logged in and show edit controls
    function checkAdminStatus() {
        const isLoggedIn = localStorage.getItem('admin-logged-in') === 'true';
        
        if (isLoggedIn) {
            const adminLock = document.querySelector('.admin-lock');
            if (adminLock) adminLock.classList.add('unlocked');
            
            let editControls = document.getElementById('editControls');
            if (!editControls) {
                // Create edit controls if they don't exist
                const pageTitle = document.querySelector('.page-title');
                if (pageTitle) {
                    editControls = document.createElement('span');
                    editControls.id = 'editControls';
                    editControls.className = 'edit-controls';
                    editControls.style.display = 'inline-block';
                    editControls.style.marginLeft = '16px';
                    editControls.style.verticalAlign = 'middle';
                    editControls.innerHTML = `
                        <button class="edit-btn" id="editBtn" onclick="toggleEditMode()" title="Modifica">
                            <img class="edit-icon" src="images/icon/gearshape.svg" alt="Modifica">
                        </button>
                        <div class="edit-actions" id="editActions" style="display: none;">
                            <button class="action-btn add-btn" onclick="addMuseum()" title="Aggiungi">
                                <img class="action-icon" src="images/icon/plus.svg" alt="Aggiungi">
                            </button>
                            <button class="action-btn edit-btn" onclick="toggleEditMuseumMode()" title="Modifica">
                                <img class="action-icon" src="images/icon/pencil.svg" alt="Modifica">
                            </button>
                            <button class="action-btn sort-btn" onclick="toggleSortMode()" title="Riordina">
                                <img class="action-icon" src="images/icon/list.number.svg" alt="Riordina">
                            </button>
                            <button class="action-btn delete-btn" onclick="toggleDeleteMode()" title="Elimina">
                                <img class="action-icon" src="images/icon/trash.svg" alt="Elimina">
                            </button>
                        </div>
                    `;
                    pageTitle.appendChild(editControls);
                }
            } else {
                editControls.style.display = 'inline-block';
            }
        }
    }
    
    // Check multiple times to ensure it works
    document.addEventListener('DOMContentLoaded', checkAdminStatus);
    window.addEventListener('load', checkAdminStatus);
    setTimeout(checkAdminStatus, 100);
    setTimeout(checkAdminStatus, 500);
    
    // Museum-specific functions - removed toggleEditMode as it's now global
    
    function clearAllActiveStates() {
        document.querySelectorAll('.edit-actions button').forEach(btn => {
            btn.style.backgroundColor = '';
        });
    }
    
    function clearAllAdminModes() {
        // Clear all admin mode classes
        document.body.classList.remove('delete-mode', 'edit-museum-mode', 'sort-mode');
        
        // Reset all museum items
        const museumItems = document.querySelectorAll('.museum-item');
        museumItems.forEach(item => {
            item.classList.remove('delete-mode', 'selected', 'sortable');
            item.style.cursor = '';
            item.style.border = '';
            item.style.paddingLeft = '';
            item.title = '';
            item.draggable = false;
            
            // Remove checkboxes and drag handles
            const checkbox = item.querySelector('.museum-checkbox');
            const dragHandle = item.querySelector('.drag-handle');
            if (checkbox) checkbox.remove();
            if (dragHandle) dragHandle.remove();
        });
        
        // Hide toolbars
        const deleteToolbar = document.getElementById('deleteToolbar');
        const sortToolbar = document.getElementById('sortToolbar');
        if (deleteToolbar) deleteToolbar.classList.remove('show');
        if (sortToolbar) sortToolbar.classList.remove('show');
        
        // Clear selected museums
        if (typeof selectedMuseums !== 'undefined') {
            selectedMuseums.clear();
        }
    }
    
    function setActiveState(button) {
        clearAllActiveStates();
        button.style.backgroundColor = '#e0e0e0';
    }
    
    function toggleEditMuseumMode() {
        const museumItems = document.querySelectorAll('.museum-item');
        const isEditMode = document.body.classList.contains('edit-museum-mode');
        const editButton = document.querySelector('button[onclick="toggleEditMuseumMode()"]');
        
        if (!isEditMode) {
            // Clear all other modes first
            clearAllAdminModes();
            // Activate edit mode
            document.body.classList.add('edit-museum-mode');
            setActiveState(editButton);
            
            museumItems.forEach(item => {
                item.style.cursor = 'pointer';
                item.style.border = '2px solid green';
                item.title = 'Clicca per modificare';
                
                item.addEventListener('click', function editMuseum() {
                    const name = item.querySelector('h3').textContent;
                    const location = item.querySelector('p').textContent;
                    
                    // Pre-fill modal with current values
                    document.getElementById('museumName').value = name;
                    document.getElementById('museumLocation').value = location;
                    document.getElementById('museumLink').value = '';
                    
                    // Change modal title
                    document.querySelector('#museumModal h3').textContent = 'Modifica Museo';
                    document.querySelector('#museumModal button[type="submit"]').textContent = 'Salva';
                    
                    // Store reference to item being edited
                    document.getElementById('museumModal').dataset.editingItem = Array.from(museumItems).indexOf(item);
                    
                    // Show modal
                    document.getElementById('museumModal').classList.add('active');
                    document.getElementById('museumName').focus();
                });
            });
        } else {
            // Deactivate edit mode
            document.body.classList.remove('edit-museum-mode');
            clearAllActiveStates();
            
            museumItems.forEach(item => {
                item.style.cursor = '';
                item.style.border = '';
                item.title = '';
                // Remove click listeners by cloning
                const newItem = item.cloneNode(true);
                item.parentNode.replaceChild(newItem, item);
            });
        }
    }
    
    function addMuseum() {
        // Clear all modes when opening add modal
        clearAllAdminModes();
        clearAllActiveStates();
        document.getElementById('museumModal').classList.add('active');
        document.getElementById('museumName').focus();
    }
    
    function closeMuseumModal() {
        const modal = document.getElementById('museumModal');
        modal.classList.remove('active');
        modal.removeAttribute('data-editing-item');
        document.getElementById('museumForm').reset();
        
        // Reset modal title and button text
        document.querySelector('#museumModal h3').textContent = 'Aggiungi Nuovo Museo';
        document.querySelector('#museumModal button[type="submit"]').textContent = 'Aggiungi';
    }
    
    let selectedMuseums = new Set();
    
    function toggleDeleteMode() {
        const museumItems = document.querySelectorAll('.museum-item');
        const isDeleteMode = document.body.classList.contains('delete-mode');
        const deleteToolbar = document.getElementById('deleteToolbar');
        const deleteButton = document.querySelector('button[onclick="toggleDeleteMode()"]');
        
        if (!isDeleteMode) {
            // Clear all other modes first
            clearAllAdminModes();
            // Activate delete mode
            document.body.classList.add('delete-mode');
            setActiveState(deleteButton);
            selectedMuseums.clear();
            
            museumItems.forEach((item, index) => {
                item.classList.add('delete-mode');
                item.classList.remove('selected');
                
                // Add checkbox if not exists
                if (!item.querySelector('.museum-checkbox')) {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'museum-checkbox';
                    checkbox.dataset.index = index;
                    
                    checkbox.addEventListener('click', function(e) {
                        e.stopPropagation();
                        toggleSelection(item, index);
                    });
                    
                    item.addEventListener('click', function(e) {
                        if (e.target === item || e.target.closest('h3') || e.target.closest('p')) {
                            toggleSelection(item, index);
                        }
                    });
                    
                    item.appendChild(checkbox);
                }
            });
            
            updateDeleteToolbar();
        } else {
            // Deactivate delete mode
            document.body.classList.remove('delete-mode');
            clearAllActiveStates();
            deleteToolbar.classList.remove('show');
            selectedMuseums.clear();
            
            museumItems.forEach(item => {
                item.classList.remove('delete-mode', 'selected');
                const checkbox = item.querySelector('.museum-checkbox');
                if (checkbox) {
                    checkbox.remove();
                }
                // Remove click listeners by cloning
                const newItem = item.cloneNode(true);
                item.parentNode.replaceChild(newItem, item);
            });
        }
    }
    
    function toggleSelection(item, index) {
        const checkbox = item.querySelector('.museum-checkbox');
        
        if (selectedMuseums.has(index)) {
            selectedMuseums.delete(index);
            item.classList.remove('selected');
            checkbox.classList.remove('checked');
        } else {
            selectedMuseums.add(index);
            item.classList.add('selected');
            checkbox.classList.add('checked');
        }
        
        updateDeleteToolbar();
    }
    
    function updateDeleteToolbar() {
        const deleteToolbar = document.getElementById('deleteToolbar');
        const deleteCount = document.querySelector('.delete-count');
        const count = selectedMuseums.size;
        
        if (count > 0) {
            deleteToolbar.classList.add('show');
            deleteCount.textContent = `${count} selezionat${count === 1 ? 'o' : 'i'}`;
        } else {
            deleteToolbar.classList.remove('show');
        }
    }
    
    function deleteSelected() {
        const count = selectedMuseums.size;
        if (count === 0) return;
        
        const message = count === 1 ? 
            'Sei sicuro di voler eliminare il museo selezionato?' : 
            `Sei sicuro di voler eliminare i ${count} musei selezionati?`;
            
        if (confirm(message)) {
            const museumItems = document.querySelectorAll('.museum-item');
            const itemsToDelete = Array.from(selectedMuseums).sort((a, b) => b - a);
            
            itemsToDelete.forEach(index => {
                if (museumItems[index]) {
                    museumItems[index].remove();
                }
            });
            
            toggleDeleteMode(); // Exit delete mode
        }
    }
    
    let isSortMode = false;
    let originalOrder = [];
    
    function toggleSortMode() {
        const museumItems = document.querySelectorAll('.museum-item');
        const sortToolbar = document.getElementById('sortToolbar');
        const sortButton = document.querySelector('button[onclick="toggleSortMode()"]');
        
        if (!isSortMode) {
            // Clear all other modes first
            clearAllAdminModes();
            // Save original order
            originalOrder = Array.from(museumItems).map(item => item.cloneNode(true));
            
            // Activate sort mode
            isSortMode = true;
            document.body.classList.add('sort-mode');
            setActiveState(sortButton);
            
            museumItems.forEach((item, index) => {
                item.classList.add('sortable');
                item.draggable = true;
                item.dataset.originalIndex = index;
                
                // Add drag handle
                if (!item.querySelector('.drag-handle')) {
                    const dragHandle = document.createElement('div');
                    dragHandle.className = 'drag-handle';
                    dragHandle.innerHTML = '⋮⋮';
                    item.appendChild(dragHandle);
                }
            });
            
            sortToolbar.classList.add('show');
            initializeDragAndDrop();
        } else {
            // Deactivate sort mode
            exitSortMode();
        }
    }
    
    function exitSortMode() {
        // Restore original order
        const museumsList = document.querySelector('.museums-list');
        museumsList.innerHTML = '';
        originalOrder.forEach(item => {
            museumsList.appendChild(item);
        });
        
        isSortMode = false;
        document.body.classList.remove('sort-mode');
        clearAllActiveStates();
        const sortToolbar = document.getElementById('sortToolbar');
        
        sortToolbar.classList.remove('show');
        removeDragAndDropListeners();
        originalOrder = [];
    }
    
    function saveSortOrder() {
        // Clear original order so changes persist until refresh
        originalOrder = [];
        
        // Exit sort mode
        isSortMode = false;
        document.body.classList.remove('sort-mode');
        clearAllActiveStates();
        const sortToolbar = document.getElementById('sortToolbar');
        sortToolbar.classList.remove('show');
        removeDragAndDropListeners();
        
        // Remove sort styling
        const museumItems = document.querySelectorAll('.museum-item');
        museumItems.forEach(item => {
            item.classList.remove('sortable');
            item.draggable = false;
            item.style.cursor = '';
            item.style.border = '';
            item.title = '';
            const dragHandle = item.querySelector('.drag-handle');
            if (dragHandle) dragHandle.remove();
        });
        
        // TODO: Here you would send the new order to your backend
        // const currentOrder = Array.from(museumItems).map(item => ({
        //     name: item.querySelector('h3').textContent,
        //     location: item.querySelector('p').textContent
        // }));
        // await fetch('/api/museums/reorder', { method: 'POST', body: JSON.stringify(currentOrder) });
    }
    
    let draggedElement = null;
    let dragListeners = [];
    let touchStartY = 0;
    let touchCurrentY = 0;
    let isDragging = false;
    
    function initializeDragAndDrop() {
        const museumsList = document.querySelector('.museums-list');
        const museumItems = document.querySelectorAll('.museum-item');
        
        museumItems.forEach((item, index) => {
            item.dataset.originalIndex = index;
            
            // Desktop drag handlers
            const dragStartHandler = (e) => {
                draggedElement = item;
                item.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', item.outerHTML);
            };
            
            const dragEndHandler = (e) => {
                item.classList.remove('dragging');
                resetItemPositions();
                draggedElement = null;
            };
            
            // Touch handlers for mobile
            const touchStartHandler = (e) => {
                e.preventDefault();
                touchStartY = e.touches[0].clientY;
                draggedElement = item;
                item.classList.add('dragging');
                isDragging = true;
            };
            
            const touchMoveHandler = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                touchCurrentY = e.touches[0].clientY;
                
                // Visual feedback
                item.style.transform = `translateY(${touchCurrentY - touchStartY}px)`;
                item.style.zIndex = '1000';
                
                // Show drop indicator on mobile
                showMobileDropIndicator(touchCurrentY);
            };
            
            const touchEndHandler = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                isDragging = false;
                
                // Reset visual state
                item.style.transform = '';
                item.style.zIndex = '';
                item.classList.remove('dragging');
                
                // Handle drop
                const indicator = document.querySelector('.drop-indicator');
                if (indicator && draggedElement) {
                    const targetElement = indicator.targetElement;
                    if (targetElement) {
                        museumsList.insertBefore(draggedElement, targetElement);
                    } else {
                        museumsList.appendChild(draggedElement);
                    }
                }
                
                resetItemPositions();
                draggedElement = null;
            };
            
            // Add all event listeners
            item.addEventListener('dragstart', dragStartHandler);
            item.addEventListener('dragend', dragEndHandler);
            item.addEventListener('touchstart', touchStartHandler, { passive: false });
            item.addEventListener('touchmove', touchMoveHandler, { passive: false });
            item.addEventListener('touchend', touchEndHandler, { passive: false });
            
            dragListeners.push({ element: item, type: 'dragstart', handler: dragStartHandler });
            dragListeners.push({ element: item, type: 'dragend', handler: dragEndHandler });
            dragListeners.push({ element: item, type: 'touchstart', handler: touchStartHandler });
            dragListeners.push({ element: item, type: 'touchmove', handler: touchMoveHandler });
            dragListeners.push({ element: item, type: 'touchend', handler: touchEndHandler });
        });
        
        const dragOverHandler = (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            if (!draggedElement) return;
            
            const afterElement = getDragAfterElement(museumsList, e.clientY);
            animateItemsForInsertion(afterElement, e.clientX, e.clientY);
        };
        
        const dropHandler = (e) => {
            e.preventDefault();
            const indicator = document.querySelector('.drop-indicator');
            if (indicator && draggedElement) {
                const targetElement = indicator.targetElement;
                if (targetElement) {
                    museumsList.insertBefore(draggedElement, targetElement);
                } else {
                    museumsList.appendChild(draggedElement);
                }
            }
        };
        
        museumsList.addEventListener('dragover', dragOverHandler);
        museumsList.addEventListener('drop', dropHandler);
        
        dragListeners.push({ element: museumsList, type: 'dragover', handler: dragOverHandler });
        dragListeners.push({ element: museumsList, type: 'drop', handler: dropHandler });
    }
    
    function showMobileDropIndicator(touchY) {
        // Remove existing indicator
        const existingIndicator = document.querySelector('.drop-indicator');
        if (existingIndicator) {
            existingIndicator.remove();
        }
        
        const allItems = Array.from(document.querySelectorAll('.museum-item:not(.dragging)'));
        const museumsList = document.querySelector('.museums-list');
        
        let targetElement = null;
        let insertPosition = 'end';
        
        // Find where to insert based on touch position
        for (let i = 0; i < allItems.length; i++) {
            const rect = allItems[i].getBoundingClientRect();
            const itemCenter = rect.top + rect.height / 2;
            
            if (touchY < itemCenter) {
                targetElement = allItems[i];
                insertPosition = 'before';
                break;
            }
        }
        
        // Create and show indicator
        const indicator = document.createElement('div');
        indicator.className = 'drop-indicator';
        indicator.style.cssText = `
            position: absolute;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: #007bff;
            z-index: 9999;
            pointer-events: none;
            box-shadow: 0 0 8px rgba(0,123,255,0.8);
            border-top: 2px solid #0056b3;
            border-bottom: 2px solid #0056b3;
        `;
        
        if (targetElement && insertPosition === 'before') {
            const rect = targetElement.getBoundingClientRect();
            const containerRect = museumsList.getBoundingClientRect();
            indicator.style.top = (rect.top - containerRect.top - 8) + 'px';
            indicator.targetElement = targetElement;
        } else {
            // Insert at end
            const lastItem = allItems[allItems.length - 1];
            if (lastItem) {
                const rect = lastItem.getBoundingClientRect();
                const containerRect = museumsList.getBoundingClientRect();
                indicator.style.top = (rect.bottom - containerRect.top + 8) + 'px';
            }
            indicator.targetElement = null;
        }
        
        museumsList.style.position = 'relative';
        museumsList.appendChild(indicator);
    }
    
    function animateItemsForInsertion(afterElement, mouseX, mouseY) {
        // Desktop version - simplified
        const existingIndicator = document.querySelector('.drop-indicator');
        if (existingIndicator) {
            existingIndicator.remove();
        }
        
        const allItems = Array.from(document.querySelectorAll('.museum-item:not(.dragging)'));
        const containerRect = document.querySelector('.museums-list').getBoundingClientRect();
        
        let closestPosition = null;
        let minDistance = Infinity;
        
        allItems.forEach((item, i) => {
            const rect = item.getBoundingClientRect();
            
            // Before each item
            const beforeDistance = Math.sqrt(Math.pow(mouseX - (rect.left - 8), 2) + Math.pow(mouseY - (rect.top + rect.height / 2), 2));
            if (beforeDistance < minDistance) {
                minDistance = beforeDistance;
                closestPosition = {
                    x: rect.left - 8 - containerRect.left,
                    y: rect.top - containerRect.top,
                    element: item
                };
            }
            
            // After each item
            const afterDistance = Math.sqrt(Math.pow(mouseX - (rect.right + 8), 2) + Math.pow(mouseY - (rect.top + rect.height / 2), 2));
            if (afterDistance < minDistance) {
                minDistance = afterDistance;
                closestPosition = {
                    x: rect.right + 8 - containerRect.left,
                    y: rect.top - containerRect.top,
                    element: allItems[i + 1] || null
                };
            }
        });
        
        if (closestPosition) {
            const indicator = document.createElement('div');
            indicator.className = 'drop-indicator';
            indicator.style.cssText = `
                position: absolute;
                left: ${closestPosition.x}px;
                top: ${closestPosition.y}px;
                width: 4px;
                height: ${document.querySelector('.museum-item').getBoundingClientRect().height}px;
                background-color: #007bff;
                border-radius: 2px;
                pointer-events: none;
            `;
            indicator.targetElement = closestPosition.element;
            
            document.querySelector('.museums-list').style.position = 'relative';
            document.querySelector('.museums-list').appendChild(indicator);
        }
    }
    
    function resetItemPositions() {
        const indicator = document.querySelector('.drop-indicator');
        if (indicator) {
            indicator.remove();
        }
    }
    
    function removeDragAndDropListeners() {
        dragListeners.forEach(({ element, type, handler }) => {
            element.removeEventListener(type, handler);
        });
        dragListeners = [];
    }
    
    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.museum-item:not(.dragging)')];
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    
    // Global toggleEditMode function
    window.toggleEditMode = function() {
        // Clear any active admin modes first
        clearAllAdminModes();
        clearAllActiveStates();
        
        const editActions = document.getElementById('editActions');
        if (editActions) {
            editActions.style.display = editActions.style.display === 'none' ? 'flex' : 'none';
        }
    }
    
    // Close admin modes when clicking outside
    document.addEventListener('click', function(e) {
        const editControls = document.getElementById('editControls');
        const editActions = document.getElementById('editActions');
        
        // Check if click is outside admin controls
        if (!e.target.closest('#editControls') && 
            !e.target.closest('.museum-item') && 
            !e.target.closest('.delete-toolbar') &&
            !e.target.closest('.sort-toolbar') &&
            !e.target.closest('#museumModal')) {
            
            // If any admin mode is active, clear it first
            if (document.body.classList.contains('delete-mode') ||
                document.body.classList.contains('edit-museum-mode') ||
                document.body.classList.contains('sort-mode')) {
                clearAllAdminModes();
                clearAllActiveStates();
            }
            // If no admin mode is active but menu is open, close menu
            else if (editActions && editActions.style.display === 'flex') {
                editActions.style.display = 'none';
            }
        }
    });
    
    // Handle form submission
    document.getElementById('museumForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = document.getElementById('museumName').value.trim();
        const location = document.getElementById('museumLocation').value.trim();
        const link = document.getElementById('museumLink').value.trim();
        const modal = document.getElementById('museumModal');
        
        if (name && location) {
            const editingIndex = modal.dataset.editingItem;
            
            if (editingIndex !== undefined) {
                // Edit existing museum
                const museumItems = document.querySelectorAll('.museum-item');
                const item = museumItems[parseInt(editingIndex)];
                
                if (link) {
                    item.innerHTML = `
                        <h3><a href="${link}" target="_blank" rel="noopener">${name}</a></h3>
                        <p>${location}</p>
                    `;
                } else {
                    item.innerHTML = `
                        <h3>${name}</h3>
                        <p>${location}</p>
                    `;
                }
                
                // Exit edit mode
                toggleEditMuseumMode();
            } else {
                // Add new museum
                const museumsList = document.querySelector('.museums-list');
                const newMuseum = document.createElement('div');
                newMuseum.className = 'museum-item';
                
                if (link) {
                    newMuseum.innerHTML = `
                        <h3><a href="${link}" target="_blank" rel="noopener">${name}</a></h3>
                        <p>${location}</p>
                    `;
                } else {
                    newMuseum.innerHTML = `
                        <h3>${name}</h3>
                        <p>${location}</p>
                    `;
                }
                
                museumsList.appendChild(newMuseum);
            }
            
            closeMuseumModal();
        }
    });
    
    // Close modal on background click
    document.getElementById('museumModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeMuseumModal();
        }
    });
    

    </script>
</body>
</html>